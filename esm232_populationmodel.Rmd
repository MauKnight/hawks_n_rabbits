---
title: "ESM 232 - Rabbit Population Matrix"
author: "Jennifer Truong, Maggie Brickner, and Mauricio Collado"
date: "05/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Using Leslie Matrices to Evolve Populations


```{r Leslie Matrix setup}
# Set up number of age classes
nclasses = 4

# create a growth matrix to store fertility and survivability information
gmatrix=matrix(nrow=nclasses, ncol=nclasses)
gmatrix

# change NAs to zero
gmatrix[]=0.0
gmatrix

# assign values for fertility for each age class 
# fertility numbers are big here because they are RABBITS!!
fert =  c(0,2,6,1)

# enter into our matrix
gmatrix[1,]=fert
 
 # now add survivability 
 # survivability (to the next class) is also per time step
gmatrix[2,1]=0.8
gmatrix[3,2]=0.85
gmatrix[4,3]=0.65

# we also want to to account for the oldest population group - they don't transfer to another group
# but they do die - this will be survivability per time step but they just stay in their class/group
gmatrix[4,4]=0.1

gmatrix

```

Now use the matrix to grow a population 
```{r}

# start with an initial population of 10 adult rabbits

p0 = rep(10, times=nclasses)

# advance to the next time step
# note the use of matrix multiplication

p1 = gmatrix %*% p0
p1

# has the total number of individuals changed?
sum(p1)
sum(p0)

# growth rate
sum(p1)/sum(p0)

#add another year
p2 = gmatrix %*% p1

# combined
pop = cbind.data.frame(p0,p1,p2)
pop$age = c("Young (Age 0-1)","Sub-Adults (Age 1-2)","Adult (Age 2-3)","Aged (Age 3-4)")

popl = pop %>% gather(key="timestep",value="pop",-age)
ggplot(popl, aes(timestep, pop,fill=as.factor(age)))+geom_col(position="dodge")+labs(fill="Age Group")


# how might you change parameters to have the population grow?

```

# Rabbit Population in 20 Years

use function to evolve a population through time
 * inputs = survivability, fertility, initial population, time steps
 * output = final population matrix
 * a dynamic model - difference equations - similar to our diffusion model
 
```{r multitime}

source("R/evolve_pop.R")

# example evolve China pop
# fertility rates
F1 = 0
F2 = 2
F3 = 6
F4 = 1

# survivability 
p12 = 0.8
p23 = 0.85
p34 = 0.65
p44 = 0.1

# initial population parameters
ini = 10
ndecades = 2
fert_rabbit = c(0,F2,F3,F4,0,0,0,0,0)
surv_rabbit = c(p12,p23,p34,p44)
rabbit_pop=evolve_pop(fert_rabbit, surv_rabbit, ini, ndecades)

head(rabbit_pop)

# graph differnt components of the output
# total population

# add decade 
decade = seq(from=1, to=ndecades)
rabbit_tot = cbind.data.frame(decade=decade, poptot=rabbit_pop$poptot) 
ggplot(rabbit_tot, aes(decade, poptot))+geom_col()+labs(y="Total Popultation")


# plot information about ages
rabbit_ages = cbind.data.frame(decade=decade, t(rabbit_pop$popbyage))
rabbit_agesl = rabbit_ages %>% gather(key="agecat", value="pop",-decade)
ggplot(rabbit_agesl, aes(decade, pop, fill=agecat))+geom_col()+labs(y="Population", fill="Age Group")

```
 
# Rabbit Population with Hawks

Hawks generally only eat younger rabbits- thus they reduce the survivability of the young and sub-adults age classes (the first two classes).  The estimates are that survivability reduced to between 0.65 and 0.75 for Ages 0-1 and between 0.75 and 0.8 for Ages 1-2. You can assume that distributions are uniform
Lets try with a more complicated example - evolving an age structured population


```{r}

source("R/evolve_pop.R")


# set up best guess case
# survivability - based on mortality rates per thousand per decade
p12 = c(0.65, 0.75)
p23 = c(0.75, 0.8)
p34 = 0.65
p44 = 0.1

F1= 0.0
F2 = 2.0
F3 = 0.3

# initial population parameters
ini = c(1000,1000, 1000)
nmonths = 12
fert_micro = c(F1,F2,F3)
surv_micro = c(p12,p23,p34)
micro_pop=evolve_pop(fert_micro, surv_micro, ini, nmonths)

# population after 12 months
micro_pop$poptot[12]
```

# Sensitivity Analysis

Now lets use Sobel to explore the how our intervention might impact the population...


AND account for uncertainty in some of our parameters

Reminder
Sobel sensitivity analysis Breaks variance of output into 

* variance associated directly with parameter alone (fraction associated with each parameter, sum to 1)
* variance associated with parameter and interaction with other parameters (sum can be more than 1)

Steps

* run sobel to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from sobel
```{r sobel}

library(sensitivity)

# survivability - based on mortality rates per thousand per decade
nsample=200

p12 = 0.9
p23 = 0.7
p34 = 0.2

# create our two samples for Sobel
# first do our survivability
ps1 = cbind.data.frame(p12=runif(min=0.4, max=0.92, n=nsample), p23 = runif(min=0.3, max=0.72, n=nsample),
                       p34 = runif(min=0.05, max=0.22, n=nsample))

ps2 = cbind.data.frame(p12=runif(min=0.4, max=0.92, n=nsample), p23 = runif(min=0.3, max=0.72, n=nsample),
                       p34 = runif(min=0.05, max=0.22, n=nsample))

# now include uncertainty in our Fertility
F1= 0.0
F2 = 2.0
F3 = 0.3

fs1 = cbind.data.frame(f1=rnorm(mean=0, sd=0, n=nsample), f2 = rnorm(mean=2.0, sd=0.1, n=nsample),
                       f3 = rnorm(mean=0.3, sd=0.01, n=nsample))

fs2 = cbind.data.frame(f1=rnorm(mean=0, sd=0, n=nsample), f2 = rnorm(mean=2.0, sd=0.1, n=nsample),
                       f3 = rnorm(mean=0.3, sd=0.01, n=nsample))


# put servivability and fertility together
allp1 = cbind.data.frame(ps1,fs1)
allp2 = cbind.data.frame(ps2,fs2)


# get sobel samples
sens_micro=soboljansen(model = NULL, allp1, allp2, nboot = 100)

head(sens_micro$X)
nsim=nrow(sens_micro$X)

# run model and save what we care about: final population after 12 months 
# this is already output by evolve_pop so we don't need a compute_metric function

ini = c(1000,1000, 1000)
nmonths = 12


# as before combine our application of the the dynamics model - for each
# parameter set, with code to extract our metric of interest (final population)
p_wrapper = function(p12, p23, p34, f1,f2,f3,use_func, initialpop, nstep ) {
fertility=c(f1,f2,f3)
survivability= c(p12,p23,p34)
res = use_func(survivability =survivability, fertility = fertility, initialpop=initialpop, nstep=nstep)
# now return the final population total
return(finalpop=res$poptot[nstep])
}

# use pmap here so we can specify rows of our sensitivity analysis parameter object 
res = as.data.frame(sens_micro$X) %>% pmap_dbl(p_wrapper, initialpop=ini, nstep=nmonths, use_func=evolve_pop)
         
# plot results (variation in final population across all parameter)
# ggplot needs a dataframe - so do a quick conversion with data.frame
ggplot(data.frame(finalpop=res), aes(x=finalpop))+geom_density()

# or a boxplot
ggplot(data.frame(finalpop=res), aes(x="", y=finalpop/1000) )+geom_boxplot(fill="blue")+
  theme(axis.title.x = element_blank())+labs(y="Final Pop (in 1000s)")

# give our results to sensitivity structure

sens_micro=tell(sens_micro, res)

# loot at results
sens_micro$S
sens_micro$T

# graph the most sensitive parameter
tmp = cbind.data.frame(sens_micro$X, pop12=sens_micro$y)
ggplot(tmp, aes(p12, pop12))+geom_point()+labs(x="Survivability of 1 to older",y="pop after 12 months")
```


